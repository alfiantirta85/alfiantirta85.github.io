<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap"
    />
    <title>Deploy Aplikasi Point of Sales (POS) di atas OpenStack</title>
    <style>
      p,
      span,
      ul,
      ol,
      div {
        font-size: 20px;
        text-align: justify;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-md navbar-light bg-white fixed-top border-bottom shadow"
    >
      <div class="container-fluid">
        <h2 class="navbar-text">
          <a
            href="https://alfiantirta85.github.io/blog"
            class="text-decoration-none"
            >Alfian Tirta</a
          >
        </h2>
        <a href="https://alfiantirta85.github.io/" class="navbar-brand">
          <img
            src="../../assets/logoBlue.png"
            alt="logo"
            style="width: 50px; height: 50px"
          />
        </a>
      </div>
    </nav>
    <div
      class="container-md border shadow p-5 mb-5"
      style="margin-top: 100px; font-family: 'Quicksand'"
    >
      <section
        id="content"
        class="d-md-flex flex-md-column justify-content-md-center align-items-md-center"
      >
        <div class="container-md content">
          <div class="mx-5 pb-3 border-bottom border-3">
            <h2 style="font-weight: bold">
              Deploy Aplikasi Point of Sales (POS) di atas OpenStack
            </h2>
            <img
              src="../assets/dashboardPOS.png"
              alt="Dashboard POS"
              class="img-fluid mt-2"
            />
          </div>
          <div class="mx-5 mt-3 border-bottom border-3">
            <p>
              Aplikasi POS atau point of sales adalah aplikasi yang digunakan
              untuk mempermudah kita dalam mengelola transaksi pada sebuah toko.
              Aplikasi POS ini dibuat menggunakan bahasa pemrograman PHP dengan
              framework laravel. Aplikasi ini menggunakan sebuah database untuk
              menyimpan datanya.
            </p>
            <span>Fitur yang tersedia:</span>
            <ul>
              <li>Manajemen Kategori Produk</li>
              <li>Manajemen Produk</li>
              <li>Manajemen Member atau Anggota</li>
              <li>Manajemen Supplier</li>
              <li>Transaksi Pengeluaran</li>
              <li>Transaksi Pembelian</li>
              <li>Transaksi Penjualan</li>
              <li>Laporan Pendapatan atau Laba & Rugi</li>
              <li>Dan lain-lain.</li>
            </ul>
            <p>
              Kali ini kita akan deploy aplikasi POS ini di atas OpenStack. Kita
              akan membuat 2 instance dengan OpenStack yang kemudian akan
              digunakan untuk web server dan database. Web server dan database
              yang akan kita gunakan adalah Nginx dan MySQL.
            </p>
            <p>Topologi yang akan kita gunakan:</p>
            <img
              src="../assets/topologiPOS.png"
              alt="tolologi POS"
              class="mx-auto d-block img-fluid"
            />
            <span>Tools yang akan kita gunakan:</span>
            <ul>
              <li>OpenStack versi zed</li>
              <li>Openstackclient versi 6.4.0</li>
              <li>PHP versi 8.1.2</li>
              <li>Nginx versi 1.18.0</li>
              <li>MySQL versi 8.0.35</li>
            </ul>
            <p>Langsung saja untuk langkah-langkah deploy aplikasi POS:</p>
            <h4 style="font-weight: bold">Membuat Project OpenStack</h4>
            <p>
              Pertama-tama, kita akan menetapkan variabel untuk terhubung dengan
              user admin di project admin. Caranya dengan mengeksekusi file rc
              yang didapat saat <i>post-deploy</i> openstack dengan
              kolla-ansible.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ source /etc/kolla/admin-openrc.sh</pre
            >
            <p>
              Karena saat kita menginstal openstackclient berada di virtual
              environment, jadi kita akan mengaktifkan virtual environmentnya
              dulu.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ source ~/kolla-venv/bin/activate</pre
            >
            <p>
              Selanjutnya, kita akan membuat project baru yang akan digunakan
              untuk mengisolasi instance kita.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack project create project-pos</pre
            >
            <p>
              Di dalam project tersebut, kita akan membuat user dengan password
              yang digunakan untuk berinteraksi dengan project melalui user
              tersebut.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack user create --project project-pos --password 'alfian123' alfian</pre
            >
            <p>
              Setelah dibuat, kita akan menetapkan role user tersebut di
              project.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack role add --user alfian --project project-pos admin</pre
            >
            <p>Verifikasi role yang di tetapkan pada user di dalam project.</p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack role assignment list --project project-pos --names
+-------+----------------+-------+----------------------+--------+--------+-----------+
| Role  | User           | Group | Project              | Domain | System | Inherited |
+-------+----------------+-------+----------------------+--------+--------+-----------+
| admin | alfian@Default |       | project-pos@Default  |        |        | False     |
+-------+----------------+-------+----------------------+--------+--------+-----------+</pre
            >
            <p>
              Buat file rc untuk menetapkan variabel yang menghubungkan ke user
              dan project yang sudah dibuat.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ vim alfian-openrc.sh
# Clear any old environment that may conflict.
for key in $( set | awk '{FS="="}  /^OS_/ {print $1}' ); do unset $key ; done
export OS_PROJECT_DOMAIN_NAME='Default'
export OS_USER_DOMAIN_NAME='Default'
export OS_PROJECT_NAME='project-pos'
export OS_TENANT_NAME='project-pos'
export OS_USERNAME='alfian'
export OS_PASSWORD='alfian123'
export OS_AUTH_URL='http://10.4.4.100:5000'
export OS_INTERFACE='internal'
export OS_ENDPOINT_TYPE='internalURL'
export OS_IDENTITY_API_VERSION='3'
export OS_REGION_NAME='RegionOne'
export OS_AUTH_PLUGIN='password'</pre
            >
            <p>
              Eksekusi file rc yang baru dibuat untuk menetapkan variabel dari
              user alfian di project-pos.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ source alfian-openrc.sh</pre
            >
            <h4 style="font-weight: bold">Membuat Instance OpenStack</h4>
            <p>
              Pertama yang kita perlukan untuk membuat instance adalah Operating
              System, kita bisa mengunduh cloud image yang berisi OS yang sudah
              dikonfigurasi. Kita akan menggunakan cloud image dari
              <a
                href="https://cloud-images.ubuntu.com/"
                class="text-decoration-none"
                target="_blank"
                >ubuntu</a
              >.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img</pre
            >
            <p>
              Selanjutnya, kita akan membuat image untuk instance di openstack
              dengan file yang sudah kita unduh tadi.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack image create --disk-format qcow2 --file ./jammy-server-cloudimg-amd64.img ubuntu-jammy</pre
            >
            <p>
              Instance tentunya memerlukan network untuk saling terhubung dengan
              instance lain ataupun ke internet. Jadi kita akan membuat network
              pada openstack.
            </p>
            <p>Pertama yang akan kita buat adalah external/provider network.</p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack network create --share --external --provider-physical-network physnet1 --provider-network-type flat ex-net-pos
$ openstack subnet create --network ex-net-pos --gateway 20.4.4.1 --no-dhcp --subnet-range 20.4.4.0/24 ex-subnet-pos</pre
            >
            <p>
              Setelah membuat external/provider network, kita akan membuat
              internal network untuk menghubungkan instance web server dengan
              database.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack network create in-net-pos
$ openstack subnet --network in-net-pos --gateway 172.16.4.1 --allocation-pool start=172.16.4.100,end=172.16.4.254 --dns-nameserver 8.8.8.8 --subnet-range 172.16.4.0/24 in-subnet-pos</pre
            >
            <p>
              Supaya instance mendapatkan internet, kita perlu menghubungkan
              internal network dengan provider network. Jadi kita akan membuat
              sebuah router yang menghubungkannya.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack router create --external-gateway ex-net-pos router-pos
$ openstack router add subnet router-pos in-subnet-pos</pre
            >
            <p>
              Secara default, traffic yang masuk ke dalam instance ditolak.
              Tetapi kita bisa membuat security group yang mengatur izin dari
              traffic tersebut.
            </p>
            <p>
              Kita akan membuat security group yang mengizinkan traffic masuk
              dengan SSH dan HTTP untuk instance web server yang akan kita buat.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack security group create secgroup-webpos --description 'Allow SSH and HTTP'
$ openstack security group rule create --ingress --protocol tcp --dst-port 22 secgroup-webpos
$ openstack security group rule create --ingress --protocol tcp --dst-port 80 secgroup-webpos</pre
            >
            <p>
              Selanjutnya, kita akan membuat security group yang mengizinkan
              traffic masuk dengan SSH dan port database untuk instance database
              yang akan dibuat
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack security group create secgroup-dbpos --description 'Allow SSH and DB'
$ openstack security group rule create --ingress --protocol tcp --dst-port 22 secgroup-dbpos
$ openstack security group rule create --ingress --protocol tcp --dst-port 3306 secgroup-dbpos</pre
            >
            <p>
              Untuk menentukan spesifik IP, kita bisa membuat port dari internal
              network yang akan digunakan instance web server dan database.
              Tetapkan security group yang sudah dibuat kepada port yang akan
              dibuat.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack port create --network in-net-pos --fixed-ip subnet=in-subnet-pos,ip-address=172.16.4.110 --security-group secgroup-webpos port-web
$ openstack port create --network in-net-pos --fixed-ip subnet=in-subnet-pos,ip-address=172.16.4.120 --security-group secgroup-dbpos port-db</pre
            >
            <p>
              Instance juga memerlukan CPU, RAM, dan disk. Kita akan membuat
              flavor yang merepresentasikan resource tersebut.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack flavor create --vcpus 1 --ram 2048 --disk 8 --public medium-pos</pre
            >
            <p>
              Karena secara default cloud image tidak memiliki password, kecuali
              CirrOS (karena untuk testing). Maka kita akan membuat keypair
              untuk masuk ke instance melalui public key SSH.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack keypair create --public-key ~/.ssh/id_rsa.pub pos-key</pre
            >
            <p>
              Selanjutnya, kita akan meluncurkan atau membuat 2 instance untuk
              web server dan database dengan resource yang sudah kita buat tadi.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack server create --image ubuntu-jammy --flavor medium-pos --nic port-id=port-web --security-group secgroup-webpos --key-name pos-key ubuntu-webpos
$ openstack server create --image ubuntu-jammy --flavor medium-pos --nic port-id=port-db --security-group secgroup-dbpos --key-name pos-key ubuntu-dbpos</pre
            >
            <p>
              Instance tersebut tidak bisa langsung kita akses. Kita perlu
              membuat floating IP dari external network.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack floating ip create --floating-ip-address 20.4.4.20 ex-net-pos
$ openstack floating ip create --floating-ip-address 20.4.4.30 ex-net-pos</pre
            >
            <p>
              Setelah dibuat, kita akan memasangkan floating IP tersebut ke
              instance yang sudah kita buat.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack server add floating ip ubuntu-webpos 20.4.4.20
$ openstack server add floating ip ubuntu-dbpos 20.4.4.30</pre
            >
            <p>
              Verifikasi instance yang sudah kita buat. Pastikan terdapat 2
              network yaitu dari internal network dan floating IP yang kita
              pasangkan.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ openstack server list
+--------------------------------------+---------------+--------+------------------------------------+--------------+------------+
| ID                                   | Name          | Status | Networks                           | Image        | Flavor     |
+--------------------------------------+---------------+--------+------------------------------------+--------------+------------+
| 190fc703-b1ce-43eb-a41d-4135bcbdcff5 | ubuntu-dbpos  | ACTIVE | in-net-pos=172.16.4.120, 20.4.4.30 | ubuntu-jammy | medium-pos |
| 26d24d5c-2971-44a3-8580-1661c6265e9f | ubuntu-webpos | ACTIVE | in-net-pos=172.16.4.110, 20.4.4.20 | ubuntu-jammy | medium-pos |
+--------------------------------------+---------------+--------+------------------------------------+--------------+------------+</pre
            >
            <h4 style="font-weight: bold">Konfigurasi Database POS</h4>
            <p>
              Pertama-tama, kita akan mengakses instance ubuntu-dbpos yang sudah
              kita buat dengan public key.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ ssh -o 'PubkeyAcceptedKeyTypes +ssh-rsa' ubuntu@20.4.4.30</pre
            >
            <p>Selanjutnya, kita akan menginstal server MySQLnya.</p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ sudo -i
# apt update
# apt install mysql-server</pre
            >
            <p>
              Kita akses MySQLnya menggunakan user root. Karena passwor dari
              user root belum kita setting, maka ketika disuruh memasukkan
              password langsung <kbd>enter</kbd> saja.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
# mysql -u root -p</pre
            >
            <p>
              Selanjutnya, kita akan membuat database yang akan digunakan untuk
              aplikasi POS.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
mysql> CREATE DATABASE point_of_sale;</pre
            >
            <p>
              Supaya tidak menggunakan user root, kita akan membuat user baru
              yang bisa diakses dari semua host untuk mengelola database
              tersebut.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
mysql> CREATE USER 'alfian'@'%' IDENTIFIED BY 'alfian';</pre
            >
            <p>
              Selanjutnya, kita akan memberikan izin user ke database yang sudah
              kita buat.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
mysql> GRANT ALL PRIVILEGES ON point_of_sales.* TO 'alfian'@'%';</pre
            >
            <p>
              Verifikasi izin user ke database. Pastikan user memiliki izin
              untuk mengelola database yang sudah dibuat.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
mysql> SHOW GRANTS FOR 'alfian'@'%';
+------------------------------------------------------------+
| Grants for alfian@%                                        |
+------------------------------------------------------------+
| GRANT USAGE ON *.* TO `alfian`@`%`                         |
| GRANT ALL PRIVILEGES ON `point_of_sales`.* TO `alfian`@`%` |
+------------------------------------------------------------+
mysql> exit</pre
            >
            <p>
              Secara default, server MySQL kita hanya bisa di akses dari
              localhost. Kita perlu mengonfigurasinya supaya bisa kita akses
              dari instance web server.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
# vim /etc/mysql/mysql.conf.d/mysqld.cnf
port            = 3306
bind-address    = 0.0.0.0</pre
            >
            <p>Terakhir, restart MySQL untuk menetapkan konfigurasinya.</p>
            <pre style="background-color: #f0f0f0" class="p-2">
# systemctl restart mysql</pre
            >
            <h4 style="font-weight: bold">Deploy Aplikasi POS</h4>
            <p>
              Pertama-tama, kita akan mengakses instance ubuntu-webpos yang
              sudah kita buat dengan public key.
            </p>
            <pre style="background-color: #f0f0f0" class="p-2">
$ ssh -o 'PubkeyAcceptedKeyTypes +ssh-rsa' ubuntu@20.4.4.20</pre
            >
          </div>
          <div
            class="footer mx-5 mt-2 p-3 d-md-flex justify-content-md-center align-items-md-center text-center"
          >
            <a href="../index.html" class="text-decoration-none"><< Back</a>
          </div>
        </div>
      </section>
    </div>
  </body>
</html>
